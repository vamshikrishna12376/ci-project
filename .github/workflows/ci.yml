name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

    - name: Static Code Analysis
      run: |
        pip install pylint
        mkdir -p reports
        pylint --output-format=parseable --reports=no src/ > reports/pylint-report.txt || true

    - name: Build
      run: |
        chmod +x scripts/build.sh
        ./scripts/build.sh

    - name: Security Scan
      run: |
        pip install bandit
        mkdir -p reports
        bandit -r src/ -f json -o reports/bandit-report.json || true

    - name: Test
      run: |
        chmod +x scripts/test.sh
        ./scripts/test.sh

    - name: Build Docker image
      run: |
        docker build -t ci-devops-app:${{ github.sha }} -f docker/Dockerfile .

    - name: Scan Docker image
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'ci-devops-app:${{ github.sha }}'
        format: 'json'
        output: 'reports/trivy-report.json'
        severity: 'CRITICAL,HIGH'

    - name: Upload test reports
      uses: actions/upload-artifact@v4
      with:
        name: test-reports
        path: reports/

  deploy-staging:
    needs: build
    if: github.ref == 'refs/heads/develop'
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1

    - name: Deploy to staging
      run: |
        chmod +x scripts/deploy.sh
        ./scripts/deploy.sh staging

    - name: Run smoke tests
      run: |
        chmod +x scripts/smoke-test.sh
        ./scripts/smoke-test.sh staging

  deploy-production:
    needs: build
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1

    - name: Deploy to production
      run: |
        chmod +x scripts/blue-green-deploy.sh
        ./scripts/blue-green-deploy.sh production

    - name: Run smoke tests
      run: |
        chmod +x scripts/smoke-test.sh
        ./scripts/smoke-test.sh production